# PRD MVP: Chat + Branch 收口（2026-02）

## 1. 背景与目标
Nexa 的 MVP 目标不是“功能展示”，而是把 ChatBot 核心体验跑通到可持续迭代状态：
- 线性聊天可连续使用。
- 产生分叉后，图谱与聊天并存，不中断提问。
- 会话、笔记、设置三条核心资产可管理、可恢复、可调试。

本轮收口聚焦“聊天与分叉主链”，作为后续标签、搜索聚合视图的基础。

## 2. 用户价值
- 用户可以像 ChatGPT/Gemini 一样连续提问与重试。
- 用户可以从回复整体或选中文案创建分叉，形成多路径思考。
- 用户可以在回复中沉淀笔记，并在“全部笔记”统一回看。
- 用户刷新页面后能够恢复会话，不因脏数据导致 silent failure。

## 3. 范围（In Scope）
### 3.1 聊天闭环
- 输入框支持 Enter 发送。
- 用户消息立即上屏。
- Assistant 通过“模型服务商 API 形态 Mock”流式回复。
- 支持 Retry 触发新回复版本。
- 同一问题多次回复支持 `< 1 / N >` 版本切换，默认显示最新。

### 3.2 分叉闭环
- 回复气泡动作创建分叉（克隆上下文）。
- 选中文案悬浮动作创建分叉（克隆上下文 + 强调文本注入）。
- 首次分叉后切换到图谱模式，但保留聊天输入能力。
- 图谱节点展示至少包含：标题、最新问答摘要、消息数、时间。

### 3.3 会话与笔记
- Sidebar “全部对话”展示历史会话列表。
- 点击会话进入主聊天区并继续提问。
- Sidebar “全部笔记”展示笔记列表。
- 在 assistant 动作区和选中浮层提供“记录笔记”。

### 3.4 设置
- Sidebar “设置”打开设置浮层。
- 至少包含模型服务商 `API Base URL` 与 `API Key` 输入项。
- 设置保存后持久化，用于后续真实模型接入。

### 3.5 稳定性与可观测性
- 关键路径日志覆盖：
  - `window.error`、`unhandledrejection`
  - 存储读写/迁移/解析失败
  - 模型调用与流式中断
  - 关键交互失败（如复制失败）
- 持久化 schema 不合法时自动清理脏数据并记录日志。

## 4. 范围外（Out of Scope）
- 真实远端 LLM API 接入（本轮保持 Mock provider）。
- 标签管理入口、搜索筛选聚合视图。
- 分享生成图片模板系统（Share 继续占位）。

## 5. 核心交互定义
## 5.1 线性聊天
1. 用户输入问题并发送。
2. 用户消息立即显示。
3. Assistant 开始流式输出。
4. 每条 assistant 回复下方显示动作按钮：Copy/Retry/Share(disabled)/Create Branch/Take Note。

## 5.2 Retry
1. 点击 Retry 触发同一问题的新回复版本。
2. 最新版本默认可见。
3. 用户可点击左右切换历史版本。

## 5.3 分叉
1. 气泡分叉：克隆截至该消息的上下文到新节点。
2. 选区分叉：在克隆基础上追加“高优先级上下文”用户消息。
3. 若会话存在任意分叉，主区渲染图谱 + 聊天双区。

## 5.4 记录笔记
1. 从回复动作区记录整条内容。
2. 从选区浮层记录选中文案。
3. 笔记可在“全部笔记”查看来源会话与时间。

## 6. 数据与状态需求
- 工作区状态（Workspace）必须包含：
  - 会话列表 + 当前会话 ID
  - 每会话图谱快照（节点、消息、激活节点）
  - 笔记集合
  - 模型服务商设置
- 支持从旧单会话快照迁移。

## 7. 验收标准（MVP Gate）
- 连续 30 轮输入/回复（含 Retry）无崩溃。
- 产生分叉后仍可继续提问。
- 刷新后会话恢复，且无无提示异常气泡（如 “1 error”）。
- “全部对话/全部笔记/设置”均可被真实点击并完成动作。
- 自动化测试覆盖：
  - 页面级主流程回归
  - 关键组件交互
  - 存储迁移与脏数据清理
- 覆盖率门槛：Statements/Lines/Functions >= 80%，Branches >= 70%。

## 8. 风险与缓解
- 风险: 图谱与聊天并存导致状态同步复杂。
  - 缓解: 统一通过会话快照提交函数更新，避免多源写入。
- 风险: 流式更新与重试并发导致组内顺序错乱。
  - 缓解: 以 `replyToMessageId` + 插入锚点控制组内顺序。
- 风险: 历史坏数据造成刷新异常。
  - 缓解: 读取时 schema 校验失败自动清理并降级到可用初始态。
