# PRD V2: 章节系统切片（细化版）

## 文档目标
定义章节系统 V2 的可交付能力、默认策略、验收场景与版本切片。  
本 PRD 对应 `V2-C1 ~ V2-C4`，用于新会话直接进入实现。

## 背景与问题
V1 已具备分叉图谱、搜索、标签与后台任务，但长对话仍缺少“结构化目录”。  
用户主要痛点：
1. 难以快速定位历史讨论段落。
2. 对话增长后上下文回顾成本高。
3. 章节更新缺失导致目录陈旧。

## 版本范围
- 本 PRD 覆盖 V2 章节主线（M7）+ M8 稳定化章节部分。
- 关联切片：
  - `V2-C1`：章节数据与任务底座。
  - `V2-C2`：自动生成与节流。
  - `V2-C3`：目录 UI 与跳转联动。
  - `V2-C4`：增量重算、版本预留、可观测性。

## 产品目标
1. 对话满足阈值时可自动生成章节目录。
2. 用户可通过目录快速跳转到章节锚点。
3. 生成失败可恢复，且不影响上一版可用目录。
4. 与现有分叉图谱结构兼容，不改变 V1 交互核心。

## 非目标（V2.0 不做）
1. 章节手动编辑器。
2. 跨会话章节聚合。
3. 章节导出 UI。
4. 高级版本 diff 界面（仅做数据预留）。

## 用户场景
1. 自动目录场景
- 长会话完成后，自动出现章节列表。
2. 快速回溯场景
- 点击某章节立即定位相关消息与分支上下文。
3. 失败恢复场景
- 章节生成失败后，用户可手动重试，且旧目录仍可用。

## 功能需求（FR）
### FR-CH-001 自动触发
- 新增内容后触发章节任务。
- 必须有节流策略，避免每条消息重算。

### FR-CH-002 手动触发
- 提供“重新生成章节”入口。
- 手动触发可绕过节流限制。

### FR-CH-003 章节实体
- 每章包含：
  - `title`
  - `summary`
  - `ordinal`
  - `start/end` 锚点（node/message）
  - `version`

### FR-CH-004 目录展示
- 会话内渲染章节列表。
- 展示生成状态（ready/generating/failed）。

### FR-CH-005 跳转联动
- 点击章节后，聊天与图谱定位到对应上下文。
- 当前章节需高亮。

### FR-CH-006 更新与重算
- 新增内容后优先局部重算，必要时全量重算。
- 重算中不阻断目录浏览。

### FR-CH-007 失败恢复
- 失败需保留上一版章节。
- 提供错误提示与重试入口。

### FR-CH-008 可观测性
- 记录任务状态、触发方式、输入规模、耗时与失败原因。

## 默认策略（V2 初始值）
1. 自动触发阈值
- 新增消息数 `>= 8` 触发。
2. 时间节流
- 同一会话最小触发间隔 `60s`。
3. 并发控制
- 同一会话同一时刻仅允许一个章节任务运行。
4. 版本保留
- 至少保留最近 `2` 版可用结果（当前版 + 上一版）。

## 非功能需求（NFR）
1. 性能
- 章节首次可见时间（触发后）`p95 < 10s`。
- 章节跳转响应 `p95 < 300ms`（本地数据场景）。
2. 稳定性
- 章节任务失败率 `< 2%`（非外部服务异常）。
3. 质量
- 新增流程需自动化测试覆盖，整体覆盖率维持 `>= 80%`。

## 数据需求
1. 新增 `chapters` 表：
- 存储章节快照与锚点范围。
2. 新增 `chapter_runs` 表（建议 V2-C2 落地）：
- 存储任务执行状态与失败信息。
3. 章节只关联 `conversation_id`，不新增 workspace 维度。

## 验收标准（按切片）
### V2-C1
- 章节表结构、仓储与手动触发 API 可用。
- 任务状态可持久化查询。

### V2-C2
- 自动触发 + 节流策略生效。
- 可生成首版章节并写入数据库。

### V2-C3
- 目录 UI 可展示、可跳转、可高亮。
- 失败状态可提示并支持重试。

### V2-C4
- 增量重算策略可用，失败自动回退全量重算。
- 可观测指标落地，性能达到目标阈值。

## 成功指标
1. 跳转准确率 `>= 95%`（验收样本）。
2. 自动章节触发后可见率 `>= 98%`（排除外部依赖失败）。
3. 用户复用章节导航行为（内部样本）逐周提升。

## 风险与缓解
1. 分叉图谱边界歧义
- 缓解：V2 默认基于“全会话时间线”切章，活跃分支模式延后。
2. LLM 输出不稳定
- 缓解：强校验 + 锚点合法性检查 + 回退策略。
3. 高频触发影响吞吐
- 缓解：阈值 + 时间节流 + 会话串行任务。

## 待确认问题
1. 切章范围是否支持“仅活跃分支”。  
默认建议：V2 仅全会话时间线。
2. 是否在 V2.0 暴露章节版本切换 UI。  
默认建议：V2 仅后端保留版本，不上 UI。
