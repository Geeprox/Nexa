# PRD V1: 分叉对话与图谱画布（更新版）

## 背景
线性 ChatBot 在研究场景中难以承载多路径思考。V1 需优先打通“可输入、可流式、可分叉、可切图谱”的最小闭环，用于后续接入真实 LLM API 前的调试与交互验证。

## 目标
- 支持用户在聊天输入框自由输入并发送问题。
- 在未接真实模型时，支持随机 Mock 回复并以流式方式输出。
- 支持两种分叉路径：
  - 回复气泡按钮分叉：克隆当前上下文到新分支。
  - 选中文本悬浮分叉：克隆上下文并追加“强调选中文案”的特殊上下文。
- 当会话产生首个分叉后，主内容区从聊天视图切换为图谱视图。

## 非目标
- V1 不接入真实远端 LLM API。
- V1 不实现多会话图谱联动。
- V1 不实现章节系统。

## 用户故事
- 我希望先像普通 ChatBot 一样输入问题并看到连续回复。
- 我希望每条 AI 回复都能快速执行复制、重试、分享（占位）、创建分叉。
- 我在阅读某段回复时，希望选中文本即可发起强调上下文的分叉。
- 一旦有分叉，我希望主区域立刻转为图谱模式，聚焦结构而不是线性滚动。

## 功能需求
- 输入交互
  - 支持 Enter 发送；支持连续提问。
  - 消息上屏后触发 Mock 回复并流式展示。
- Mock 回复
  - 内置多条较长回复模板，随机返回。
  - 初始历史聊天记录默认展示，便于开箱调试。
- 回复气泡动作
  - 每条 assistant 气泡底部左对齐展示：`Copy`、`Retry`、`Share`、`Create Branch`。
  - `Share` 为占位按钮（后续升级为图片分享）。
- 重试能力
  - 点击 `Retry` 会新增一版回复（Mock）。
  - 展示 `< 1 / 2 >` 形式的版本切换控制，默认显示最新版本。
- 分叉能力
  - 气泡 `Create Branch`：克隆截至当前回复的上下文。
  - 选中文本悬浮 `分叉`：克隆上下文后追加强调选中文案的用户消息。
- 视图切换
  - 无分叉：主区域为聊天视图。
  - 有分叉：主区域切换为图谱视图。

## 交互流程
1. 用户输入问题并发送。
2. 系统上屏用户消息并流式输出 Mock 回复。
3. 用户可对任一回复执行复制/重试/创建分叉。
4. 分叉创建后，系统插入新节点并切换主区域到图谱视图。

## 数据需求
- Node 与 Message 的映射需可持久化。
- Message 需支持重试组信息：`reply_to_message_id`、`retry_index`。
- 分叉需记录来源消息与选中文案（若有）。

## 约束
- 交互反馈应在 1s 内完成（除流式完整输出）。
- 图谱拖拽与缩放在常规规模下保持流畅。
- 需兼容本地快照恢复（含分支与重试信息）。

## 成功指标
- 输入-回复闭环稳定运行，支持连续 20+ 轮 Mock 对话无崩溃。
- 分叉创建后主区域切换准确率 100%。
- 重试版本切换控制可稳定显示并切换。

## 风险
- 流式定时器与状态更新并发导致消息乱序。
- 分叉克隆时若消息引用映射不完整，可能导致上下文断裂。

## 未决问题
- 分叉后是否保留“聊天与图谱双栏同时可见”的开关（当前为强切图谱）。
- 图谱模式下继续提问入口的最终产品形态。
