# PRD V2: 自然语言视图规则（细化版）

## 文档目标
定义 V2 自然语言视图规则的可交付边界、验收口径与迭代切片，作为 I1-I3 的直接开发输入，I7 作为稳定化补齐。

## 背景与问题
V1 已完成标签体系、自动标签、规则执行基础类型，但用户仍需手工理解标签组合，无法把“研究意图”沉淀为可复用视图。  
核心问题是：自然语言表达和结构化规则之间缺少稳定、可解释、可恢复的编译链路。

## 版本范围
- 本 PRD 对应 V2 里程碑 `M6 + M8.1（部分）`。
- 关联切片：
  - `V2-R1`：`view_rules` 持久化 + 确定性 parser。
  - `V2-R2`：LLM 编译 + 校验 + 预览执行。
  - `V2-R3`：视图 UI（创建/编辑/删除/解释）。
  - `V2-R4`：稳定性与性能优化。

## 产品目标
1. 用户可用自然语言创建视图并保存复用。
2. 系统必须同时保存 `rule_nl`（原始输入）与 `rule_json`（结构化规则）。
3. 规则对 Conversation 与 Note 同时生效。
4. 规则执行结果可预览、可解释、可回放。
5. 编译失败不阻塞主流程，必须有降级与重试路径。

## 非目标（V2.0 不做）
1. Workspace/Project 层级。
2. 复杂谓词（时间、范围、因果、跨实体字段）。
3. 团队协作与权限视图。
4. 导出 UI（仅预留导出兼容字段）。
5. `NOT` 语义（默认延后，见待确认问题）。

## 目标用户与场景
1. 研究用户
- 需求：把“方法+对比”类表达快速固化为可复用视图。
2. 知识沉淀用户
- 需求：把“需要复盘”这类口语规则转为稳定过滤条件。
3. 维护型用户
- 需求：看到结构化规则解释，必要时可手改并回滚。

## 用户旅程
1. 创建
- 输入 `view name + rule_nl`。
- 系统返回结构化规则摘要 + 命中统计。
- 用户确认后保存。
2. 使用
- 打开视图查看聚合结果（Conversation + Note）。
- 点击结果跳转到原内容。
3. 调整
- 编辑自然语言规则或结构化规则。
- 预览命中差异后确认保存。
4. 失败恢复
- 编译失败时收到错误原因与修复建议。
- 可重试或切换为手动结构化编辑。

## 功能需求（FR）
### FR-NL-001 视图创建
- 输入：`name`, `rule_nl`。
- 输出：可保存的 `rule_json` 与预览结果。
- 约束：`name` 非空且同名冲突时给出提示。

### FR-NL-002 确定性解析
- 支持显式 `AND` / `OR` / 括号。
- 标签词元需标准化（trim、大小写归一）。
- 解析成功时允许绕过 LLM 直接进入校验。

### FR-NL-003 LLM 编译补全
- 仅在 parser 失败或置信度不足时触发。
- 需输出可校验 AST；无效输出必须拒绝入库。

### FR-NL-004 规则预览
- 保存前返回命中总数、Conversation 命中数、Note 命中数、样例列表。
- 预览执行失败时返回可读错误，不创建脏数据。

### FR-NL-005 规则管理
- 支持列表、重命名、编辑、删除。
- 编辑保存后保留“最近一版可用规则”用于失败回退。

### FR-NL-006 可解释性
- 展示原始 `rule_nl`。
- 展示结构化摘要（人类可读）。
- 发生 LLM 改写时展示改写说明。

### FR-NL-007 错误与恢复
- 错误类型最少包括：语法错误、LLM 超时、校验失败、执行失败。
- 每类错误必须对应修复建议与重试入口。

### FR-NL-008 兼容现有标签体系
- 手动标签和自动标签统一参与规则执行。
- 系统标签删除逻辑保持不变。

## 非功能需求（NFR）
1. 性能
- `<= 5000` 实体场景下，预览执行 `p95 < 800ms`。
- 创建视图到首个结果展示中位时延 `< 2s`。
2. 可用性
- 编译链路失败时有可恢复路径，禁止静默失败。
3. 一致性
- 同一 `rule_json + 数据快照` 的执行结果必须可复现。
4. 质量
- 新增能力测试覆盖并保持全项目覆盖率 `>= 80%`。

## 数据需求
1. 新增 `view_rules` 持久化实体：
- `id`, `name`, `rule_nl`, `rule_json`, `parse_version`, `last_error`, `created_at`, `updated_at`。
2. 预留审计字段：
- `last_compiled_at`, `compile_source`（deterministic/llm）。
3. 结果层：
- 不强制持久化全量结果，需保留执行统计结构供监控使用。

## 验收标准（按切片）
### V2-R1
- AND/OR/括号规则可被 parser 正确生成 AST。
- `view_rules` CRUD 可用，非法规则不可入库。

### V2-R2
- 口语表达可转结构化规则并通过校验。
- 预览可返回双实体统计；失败路径可观测。

### V2-R3
- 视图创建/编辑/删除流程闭环。
- UI 可显示原始输入与结构化摘要。

### V2-R4
- 异常回退可用，性能指标达标。
- 回归测试通过，无 V1 行为回归。

## 成功指标
1. 编译成功率（可保存）`>= 90%`。
2. 执行错误率 `< 1%`（非非法输入场景）。
3. 创建成功后 7 日留存视图使用率（内部样本）逐周提升。

## 依赖与约束
1. 依赖现有 `TagRepository`, `JobQueue`, `DatabaseAdapter`。
2. 维持 macOS 首发与本地优先架构。
3. 不引入服务端强依赖。

## 风险与缓解
1. 自然语言歧义
- 缓解：parser 优先、LLM 次之、强校验兜底。
2. 标签噪声导致结果不稳定
- 缓解：标签归一、保留可解释摘要与手动编辑。
3. 规则复杂度增长
- 缓解：V2 限制语法面，复杂语义延后到 V3。

## 待确认问题
1. `NOT` 是否进入 V2.0。  
默认建议：不进入，避免 parser/执行器扩展过大。
2. 是否保留“结果冻结快照”。  
默认建议：V2 仅记录统计，不冻结实体快照。
