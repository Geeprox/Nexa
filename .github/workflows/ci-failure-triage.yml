name: CI Failure Triage

on:
  workflow_run:
    workflows:
      - CI
    types:
      - completed

permissions:
  actions: read
  contents: read
  issues: write

jobs:
  triage:
    if: >
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Create or update CI failure issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const run = context.payload.workflow_run;
            const shortSha = run.head_sha.slice(0, 7);
            const title = `[CI] main failure @ ${shortSha}`;

            const jobs = await github.paginate(
              github.rest.actions.listJobsForWorkflowRun,
              {
                owner,
                repo,
                run_id: run.id,
                per_page: 100
              }
            );

            const failedJobs = jobs.filter((job) => job.conclusion === "failure");
            const failedJobLines = failedJobs.length
              ? failedJobs
                  .map((job) => {
                    const failedSteps = (job.steps ?? [])
                      .filter((step) => step.conclusion === "failure")
                      .map((step) => step.name)
                      .join(", ");
                    return `- ${job.name}${failedSteps ? ` (failed steps: ${failedSteps})` : ""}`;
                  })
                  .join("\n")
              : "- Unknown (no failed job details available)";

            const body = [
              "## CI Failure Detected",
              "",
              `- Workflow: **${run.name}**`,
              `- Branch: \`${run.head_branch}\``,
              `- Commit: \`${run.head_sha}\``,
              `- Trigger: \`${run.event}\``,
              `- Run: ${run.html_url}`,
              "",
              "### Failed Jobs",
              failedJobLines,
              "",
              "### Next Actions",
              "1. Reproduce locally (`npm test`, `npm run build`, `cargo build`).",
              "2. Fix and verify.",
              "3. Link fix PR to this issue."
            ].join("\n");

            const { data: openIssues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: "open",
              per_page: 100
            });

            const existing = openIssues.find((issue) => issue.title === title);
            if (existing) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: existing.number,
                body: [
                  "A new failed run was detected for the same commit.",
                  "",
                  `- Run: ${run.html_url}`,
                  "",
                  "### Failed Jobs",
                  failedJobLines
                ].join("\n")
              });
              core.info(`Updated issue #${existing.number}`);
              return;
            }

            const { data: issue } = await github.rest.issues.create({
              owner,
              repo,
              title,
              body
            });
            core.info(`Created issue #${issue.number}`);
